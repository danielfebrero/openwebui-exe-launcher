name: Build Portable macOS App (Ollama + Open WebUI)

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  release:
    types: [created]

jobs:
  build:
    runs-on: macos-latest
    strategy:
      matrix:
        python-version: ["3.11", "3.12"]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Download Ollama binary (latest)
        run: |
          LATEST_TAG=$(curl -s https://api.github.com/repos/ollama/ollama/releases/latest | grep '"tag_name"' | sed -E 's/.*"([^"]+)".*/\1/')
          echo "Downloading Ollama $LATEST_TAG"

          echo "Available assets:"
          curl -s "https://api.github.com/repos/ollama/ollama/releases/latest" | grep '"name"' | sed -E 's/.*"([^"]+)".*/\1/' | sed 's/^/ - /' || true

          # Candidate patterns to try in order; prefer arch-specific builds
          PATTERNS=("darwin.*arm64" "darwin.*amd64" "darwin" "macos")

          DOWNLOAD_URL=""
          for p in "${PATTERNS[@]}"; do
            echo "Searching assets matching: $p"
            DOWNLOAD_URL=$(curl -s "https://api.github.com/repos/ollama/ollama/releases/latest" \
              | grep '"browser_download_url"' \
              | sed -E 's/.*"([^"]+)".*/\1/' \
              | grep -iE "$p" \
              | head -n 1 || true)
            if [ -n "$DOWNLOAD_URL" ]; then
              echo "Selected: $DOWNLOAD_URL"
              break
            fi
          done

          if [ -z "$DOWNLOAD_URL" ]; then
            echo "No darwin asset found in release; falling back to 'ollama-darwin'"
            DOWNLOAD_URL="https://github.com/ollama/ollama/releases/download/${LATEST_TAG}/ollama-darwin"
          fi

          # Try downloading a single file. If it is an archive, extract and find 'ollama'.
          TEMP_DIR=$(mktemp -d)
          OLLAMA_DEBUG_DIR="$(pwd)/ollama_artifacts"
          mkdir -p "$OLLAMA_DEBUG_DIR"
          for i in 1 2 3; do
            echo "Download attempt $i/3..."
            if curl -L "$DOWNLOAD_URL" -o "$TEMP_DIR/ollama_asset"; then
              file "$TEMP_DIR/ollama_asset" || true
              # If it's a ZIP or tar(ball), try to extract to find a contained 'ollama' binary
              if file "$TEMP_DIR/ollama_asset" | grep -qi "zip\|gzip\|tar"; then
                echo "Archive downloaded; extracting to temp for scan"
                if unzip -l "$TEMP_DIR/ollama_asset" >/dev/null 2>&1; then
                  unzip -o "$TEMP_DIR/ollama_asset" -d "$TEMP_DIR/ollama_unpack"
                else
                  tar -xf "$TEMP_DIR/ollama_asset" -C "$TEMP_DIR/ollama_unpack" || true
                fi
                find "$TEMP_DIR/ollama_unpack" -type f -iname '*ollama*' -print -exec cp {} "$OLLAMA_DEBUG_DIR/" \; -quit || true
              else
                # It's already a binary, move/rename for PyInstaller
                mv "$TEMP_DIR/ollama_asset" "$OLLAMA_DEBUG_DIR/ollama"
              fi

              if [ -f "$OLLAMA_DEBUG_DIR/ollama" ] && [ -s "$OLLAMA_DEBUG_DIR/ollama" ]; then
                chmod +x "$OLLAMA_DEBUG_DIR/ollama" || true
                # copy to repo root so PyInstaller can include it
                cp "$OLLAMA_DEBUG_DIR/ollama" ollama || true
                echo "✓ ollama binary prepared"
                break
              fi
            fi

            if [ $i -eq 3 ]; then
              echo "ERROR: ollama download failed after 3 attempts"
              exit 1
            fi

            echo "Retrying in 5 seconds..."
            sleep 5
          done
          # Do not remove the debug folder here - we'll upload it as an artifact afterwards
          rm -rf "$TEMP_DIR" || true

      - name: Build portable .app with PyInstaller
        run: |
          # Build macOS app bundle with console for debugging
          pyinstaller --clean openwebui-portable-macos.spec

          if [ -d "dist/OpenWebUI-Ollama.app" ]; then
            echo "✓ Build successful"
          else
            echo "ERROR: Build failed - .app bundle not found"
            exit 1
          fi

      - name: Create portable DMG package
        run: |
          # Install create-dmg for better DMG creation
          brew install create-dmg

          # Create DMG without icon reference (no icon bundled)
          # create-dmg can be picky about the --icon argument. If it fails we'll fall back to hdiutil.
          create-dmg \
            --volname "OpenWebUI-Ollama-Portable" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --icon "dist/OpenWebUI-Ollama.app" 175 120 \
            --hide-extension "OpenWebUI-Ollama.app" \
            --app-drop-link 425 120 \
            --no-internet-enable \
            "OpenWebUI-Ollama-Portable-macOS.dmg" \
            "dist/" || true

          # Fallback to simple DMG if create-dmg fails
          if [ ! -f "OpenWebUI-Ollama-Portable-macOS.dmg" ]; then
            echo "Creating simple DMG..."
            hdiutil create -volname "OpenWebUI-Ollama-Portable" \
              -srcfolder "dist/OpenWebUI-Ollama.app" \
              -ov -format UDZO \
              "OpenWebUI-Ollama-Portable-macOS.dmg"
          fi

          if [ -f "OpenWebUI-Ollama-Portable-macOS.dmg" ]; then
            echo "✓ DMG created successfully"
          else
            echo "ERROR: DMG creation failed"
            exit 1
          fi

          # Basic verification: ensure the contained ollama binary exists and is executable
          # To help debug packaging, list what's inside the app bundle (Contents/MacOS and Resources)
          echo "Contents of app bundle (Contents/MacOS):"
          ls -la "dist/OpenWebUI-Ollama.app/Contents/MacOS" || true
          echo "Contents of app bundle (Resources):"
          ls -la "dist/OpenWebUI-Ollama.app/Contents/Resources" || true

          if [ -f "dist/OpenWebUI-Ollama.app/Contents/MacOS/ollama" ]; then
            echo "Found bundled ollama binary inside app:" 
            ls -l "dist/OpenWebUI-Ollama.app/Contents/MacOS/ollama"
          else
            echo "ERROR: ollama binary not found inside the .app bundle"
            exit 1
          fi

      - name: Create archive of dist for diagnostics (macOS)
        if: failure()
        run: |
          if [ -d "dist" ]; then
            tar -czf openwebui-dist-macos.tgz dist
            echo "Created openwebui-dist-macos.tgz"
          else
            echo "No dist/ directory to archive"
          fi

      - name: Upload 'dist' artifact on failure (macOS)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: openwebui-dist-macos
          path: openwebui-dist-macos.tgz

      - name: Upload ollama extraction artifacts (diagnostic)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ollama-diagnostics-macos
          path: |
            ollama_artifacts/**
            ollama

      - name: Create README for macOS
        run: |
          cat > "README-macOS.txt" << 'EOF'
          # Open WebUI + Ollama Portable Launcher (macOS)

          ## Quick Start
          1. Open the DMG file
          2. Drag "OpenWebUI-Ollama.app" to Applications (or any folder)
          3. Right-click the app and select "Open" (first time only - for Gatekeeper)
          4. Click "Open" in the security dialog
          5. Wait for the browser to open automatically
          6. Access the interface at http://localhost:3000

          ## Features
          - Fully portable - can run from any location
          - No installation required
          - All data stored in the application folder
          - GPU acceleration (Metal/CUDA if available)

          ## Data Locations
          The app creates these folders next to OpenWebUI-Ollama.app:
          - .ollama/models/ - AI models
          - data/ - User data and settings

          ## Troubleshooting

          ### First Launch Security
          macOS will block the app on first launch. To fix:
          1. Right-click (or Control-click) the app
          2. Select "Open" from the menu
          3. Click "Open" in the dialog

          Or use Terminal:
          xattr -cr /path/to/OpenWebUI-Ollama.app

          ### Ports in Use
          If ports 11434 or 3000 are in use:
          - Close other Ollama instances
          - Check Activity Monitor for processes using these ports

          ### Firewall Permissions
          macOS may ask for network access:
          - Click "Allow" for localhost communication

          ## Shutdown
          - Use Cmd+Q to quit
          - Or close from the menu bar
          - Or use Activity Monitor to force quit if needed

          ## System Requirements
          - macOS 10.15 (Catalina) or later
          - 8GB RAM minimum (16GB recommended)
          - 10GB+ free disk space (for models)
          EOF

          echo "✓ README created"

      - name: Cleanup on failure
        if: failure()
        run: |
          echo "Cleaning up build artifacts..."
          rm -f ollama
          rm -rf dist
          rm -rf build
          rm -f *.dmg

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: openwebui-ollama-portable-macos
          path: |
            OpenWebUI-Ollama-Portable-macOS.dmg
            README-macOS.txt

      - name: Upload to release (if tagged)
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: |
            OpenWebUI-Ollama-Portable-macOS.dmg
            README-macOS.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
