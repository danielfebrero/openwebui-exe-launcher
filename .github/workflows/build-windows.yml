name: Build Portable Windows EXE (Ollama + Open WebUI)

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  release:
    types: [created]

jobs:
  build:
    runs-on: windows-latest
    strategy:
      matrix:
        python-version: ["3.11", "3.12"]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Download Ollama binary (latest)
        shell: pwsh
        run: |
          $latest = Invoke-RestMethod -Uri "https://api.github.com/repos/ollama/ollama/releases/latest"
          $latestTag = $latest.tag_name
          Write-Host "Downloading Ollama $latestTag"

          # Prefer windows release assets, and try multiple candidates if the first one doesn't contain an exe.
          Write-Host "Available assets:"
          $latest.assets | ForEach-Object { Write-Host " - $($_.name)" }

          # Candidate asset filters: prefer non-rocm amd64 builds, but fall back to other 'windows' assets
          $priorityPatterns = @('windows.*amd64','windows.*64','windows')

          $assetCandidates = @()
          foreach ($p in $priorityPatterns) {
            $assetCandidates += $latest.assets | Where-Object { $_.name -match $p }
          }
          # remove duplicates
          $assetCandidates = $assetCandidates | Select-Object -Unique

          if (-not $assetCandidates -or $assetCandidates.Count -eq 0) {
            Write-Host "WARNING: No windows asset found in release; falling back to default name"
            $assetCandidates = @(
              @{ name = 'ollama-windows-amd64.zip'; browser_download_url = "https://github.com/ollama/ollama/releases/download/$latestTag/ollama-windows-amd64.zip" }
            )
          }

          # Try each candidate asset until we find an asset that contains a windows exe.
          $found = $false
          Write-Host "Number of candidate assets: $($assetCandidates.Count)"
          foreach ($asset in $assetCandidates) {
            $assetName = $asset.name


            Write-Host "Trying asset: $assetName"
            $url = $asset.browser_download_url

            # Retry download up to 3 times for this asset
            $maxRetries = 3
            for ($i = 1; $i -le $maxRetries; $i++) {
            try {
              Write-Host "Download attempt $i/$maxRetries..."
              # Save the downloaded file using asset name extension if available
              $ext = [System.IO.Path]::GetExtension($assetName)
              $downloadPath = "ollama_download$ext"
              Invoke-WebRequest -Uri $url -OutFile $downloadPath -ErrorAction Stop

              # If archive is a ZIP, expand and search for any Windows EXE containing 'ollama'
              if ($downloadPath -match '\.zip$') {
                # Ensure destination exists to avoid chdir errors when extracting
                if (-not (Test-Path "ollama_temp")) { New-Item -ItemType Directory -Path "ollama_temp" | Out-Null }
                Expand-Archive -Path $downloadPath -DestinationPath "ollama_temp" -Force
                $ollamaExe = Get-ChildItem -Path "ollama_temp" -Recurse -File | Where-Object { $_.Name -match 'ollama' -and $_.Extension -ieq '.exe' } | Select-Object -First 1
              } else {
                # Not a zip; try to locate 'ollama' exe in the current working folder or as the download
                $ollamaExe = $null
                if ($downloadPath -match '\.exe$') {
                  $ollamaExe = Get-Item -Path $downloadPath -ErrorAction SilentlyContinue
                }
                if (-not $ollamaExe) {
                  $ollamaExe = Get-ChildItem -Path '.' -Filter '*ollama*.exe' -Recurse | Select-Object -First 1
                }
              }
              if ($ollamaExe) {
                Copy-Item $ollamaExe.FullName -Destination "ollama.exe" -Force
                # Remove temporary files if present
                if (Test-Path "ollama_temp") { Remove-Item "ollama_temp" -Recurse -Force }
                if (Test-Path $downloadPath) { Remove-Item $downloadPath -Force }
                Write-Host "✓ ollama.exe downloaded successfully"
                $found = $true
                break
              } else {
                Write-Host "ollama.exe not found inside $assetName"
                if ($downloadPath -match '\.zip$') {
                  # For diagnostics, list the archive contents for debugging
                  Write-Host "Contents of ${assetName}:"
                  Get-ChildItem -Path "ollama_temp" -Recurse | Select-Object FullName | ForEach-Object { Write-Host (" - " + $_.FullName) }
                }
                # remove any temporary extraction so next candidate starts clean
                if (Test-Path "ollama_temp") { Remove-Item "ollama_temp" -Recurse -Force }
              }
            } catch {
              if ($i -eq $maxRetries) {
                Write-Host "Failed to download or extract $assetName after $maxRetries attempts: $_"
              }
              Write-Host "Retrying in 5 seconds..."
              Start-Sleep -Seconds 5
            }

            if ($found) { break }
          }

          if (-not $found) {
            throw "ERROR: Failed to download ollama.exe: none of the windows assets contained an executable (tried $($assetCandidates.Count) candidate(s))."
          }

      - name: Build portable EXE with PyInstaller
        shell: pwsh
        run: |
          # Build with console for debugging and portability
          pyinstaller --clean openwebui-portable.spec

          if (Test-Path "dist\OpenWebUI-Ollama-Portable\OpenWebUI-Ollama-Portable.exe") {
            Write-Host "✓ Build successful"
            # Verify ollama.exe exists in the packaged directory
              if (Test-Path "dist\OpenWebUI-Ollama-Portable\ollama.exe") {
                Write-Host "✓ ollama.exe found in package"
              } else {
                throw "ERROR: ollama.exe not found in packaged directory - build is incomplete"
              }
          } else {
            throw "ERROR: Build failed - executable not found"
          }

      - name: Create portable ZIP package
        shell: pwsh
        run: |
          # Create a clean portable package
          $packageName = "OpenWebUI-Ollama-Portable-Windows"
          New-Item -ItemType Directory -Force -Path $packageName

          # Copy the built application
          Copy-Item -Recurse "dist\OpenWebUI-Ollama-Portable\*" "$packageName\"

          # Create README for users
          @"
          # Open WebUI + Ollama Portable Launcher

          ## Quick Start
          1. Extract this entire folder to a USB drive or any location
          2. Run OpenWebUI-Ollama-Portable.exe
          3. Wait for the browser to open automatically
          4. Access the interface at http://localhost:3000

          ## Features
          - Fully portable - runs from USB drive
          - No installation required
          - Leaves no traces on the host computer
          - All data stored in the application folder

          ## Data Locations
          - Models: .ollama/models/
          - User data: data/

          ## Troubleshooting
          - If ports 11434 or 3000 are in use, close other applications
          - Firewall may ask for permission - click Allow
          - First model download will take time

          ## Shutdown
          Press Ctrl+C in the console window or close the window
          "@ | Out-File -FilePath "$packageName\README.txt" -Encoding utf8

          # Create ZIP
          Compress-Archive -Path $packageName -DestinationPath "$packageName.zip" -Force
          Write-Host "✓ Portable package created: $packageName.zip"

      - name: Cleanup on failure
        if: failure()
        shell: pwsh
        run: |
          Write-Host "Cleaning up build artifacts..."
          Remove-Item -Path "ollama.exe" -ErrorAction SilentlyContinue
          Remove-Item -Path "ollama.zip" -ErrorAction SilentlyContinue
          Remove-Item -Path "ollama_download*" -ErrorAction SilentlyContinue
          Remove-Item -Path "ollama_temp" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "dist" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "build" -Recurse -Force -ErrorAction SilentlyContinue

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: openwebui-ollama-portable-windows
          path: OpenWebUI-Ollama-Portable-Windows.zip
          compression-level: 0 # Already compressed

      - name: Upload ollama extraction artifacts (diagnostic)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ollama-diagnostics-windows
          path: |
            ollama_temp/**
            ollama_download*
            ollama.zip
            ollama.exe

      - name: Upload built 'dist' when build fails (diagnostic)
        if: failure()
        shell: pwsh
        run: |
          if (Test-Path "dist") {
            $zipName = "openwebui-dist-windows.zip"
            if (Test-Path $zipName) { Remove-Item $zipName -Force }
            Compress-Archive -Path "dist\*" -DestinationPath $zipName -Force
            Write-Host "Created $zipName"
          } else {
            Write-Host "No dist dir present"
          }

      - name: Upload 'dist' artifact on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: openwebui-dist-windows
          path: openwebui-dist-windows.zip

      - name: Upload to release (if tagged)
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: OpenWebUI-Ollama-Portable-Windows.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
