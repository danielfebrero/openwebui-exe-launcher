name: Build Portable Windows EXE (Ollama + Open WebUI)

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  release:
    types: [created]

jobs:
  build:
    runs-on: windows-latest
    strategy:
      matrix:
        python-version: ["3.12"]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller
          pip install python-magic-bin

      - name: Lint download script (PowerShell syntax only)
        shell: pwsh
        run: |
          $errors = $null
          [System.Management.Automation.Language.Parser]::ParseFile('ci/download-ollama-windows.ps1', [ref]$null, [ref]$errors)
          if ($errors.Count -gt 0) {
            Write-Host "PowerShell parsing errors found:";
            $errors | ForEach-Object { Write-Host $_.ToString() }
            exit 1
          }
          Write-Host "PowerShell parse OK"

      - name: Download Ollama binary (latest)
        shell: pwsh
        run: |
          pwsh -NoProfile -File ci/download-ollama-windows.ps1

      - name: Build portable Windows app (PyInstaller)
        shell: pwsh
        run: |
          if (-not (Test-Path "ollama.exe")) {
            throw "ollama.exe missing; download step must succeed before building."
          }
          pyinstaller --noconfirm openwebui-portable.spec

          # Create README for users
          @"
          # Open WebUI + Ollama Portable Launcher

          ## Quick Start
          1. Run OpenWebUI-Ollama-Portable.exe
          2. Wait for the browser to open automatically
          3. Access the interface at http://localhost:3000

          ## Features
          - Fully portable - runs from USB drive
          - No installation required
          - Leaves no traces on the host computer
          - All data stored in the application folder

          ## Data Locations
          - Models: .ollama/models/
          - User data: data/

          ## Troubleshooting
          - If ports 11434 or 3000 are in use, close other applications
          - Firewall may ask for permission - click Allow
          - First model download will take time

          ## Shutdown
          Press Ctrl+C in the console window or close the window
          "@ | Out-File -FilePath "dist\OpenWebUI-Ollama-Portable\README.txt" -Encoding utf8
          Write-Host "âœ“ Portable app created with README"

      - name: Cleanup on failure
        if: failure()
        shell: pwsh
        run: |
          Write-Host "Cleaning up build artifacts..."
          Remove-Item -Path "ollama.exe" -ErrorAction SilentlyContinue
          Remove-Item -Path "ollama.zip" -ErrorAction SilentlyContinue
          Remove-Item -Path "ollama_download*" -ErrorAction SilentlyContinue
          Remove-Item -Path "ollama_temp" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "dist" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "build" -Recurse -Force -ErrorAction SilentlyContinue

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: openwebui-ollama-portable-windows
          path: dist/OpenWebUI-Ollama-Portable/

      - name: Upload ollama extraction artifacts (diagnostic)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ollama-diagnostics-windows
          path: |
            ollama_temp/**
            ollama_download*
            ollama.zip
            ollama.exe

      - name: Upload built 'dist' when build fails (diagnostic)
        if: failure()
        shell: pwsh
        run: |
          if (Test-Path "dist") {
            $zipName = "openwebui-dist-windows.zip"
            if (Test-Path $zipName) { Remove-Item $zipName -Force }
            Compress-Archive -Path "dist\*" -DestinationPath $zipName -Force
            Write-Host "Created $zipName"
          } else {
            Write-Host "No dist dir present"
          }

      - name: Upload 'dist' artifact on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: openwebui-dist-windows
          path: openwebui-dist-windows.zip

      - name: Create ZIP for release
        if: github.event_name == 'release'
        shell: pwsh
        run: |
          Compress-Archive -Path "dist\OpenWebUI-Ollama-Portable\*" -DestinationPath "OpenWebUI-Ollama-Portable-Windows.zip" -Force

      - name: Upload to release (if tagged)
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: OpenWebUI-Ollama-Portable-Windows.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
