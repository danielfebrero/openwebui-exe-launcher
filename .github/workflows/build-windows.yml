name: Build Portable Windows EXE (Ollama + Open WebUI)

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  release:
    types: [created]

jobs:
  build:
    runs-on: windows-latest
    strategy:
      matrix:
        python-version: ["3.11", "3.12"]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Download Ollama binary (latest)
        shell: pwsh
        run: |
          $latest = Invoke-RestMethod -Uri "https://api.github.com/repos/ollama/ollama/releases/latest"
          $latestTag = $latest.tag_name
          Write-Host "Downloading Ollama $latestTag"

          # Prefer a windows-amd64 zip asset, but fall back to any asset that contains windows
          $asset = $latest.assets | Where-Object { $_.name -match 'windows' -and $_.name -match 'zip' } | Select-Object -First 1
          if (-not $asset) {
            # Fallback: try amd64 zip specifically
            $asset = $latest.assets | Where-Object { $_.name -match 'windows' } | Select-Object -First 1
          }
          if ($asset) {
            $url = $asset.browser_download_url
          } else {
            Write-Host "WARNING: No windows asset found in release; falling back to default name"
            $url = "https://github.com/ollama/ollama/releases/download/$latestTag/ollama-windows-amd64.zip"
          }

          # Retry download up to 3 times
          $maxRetries = 3
          for ($i = 1; $i -le $maxRetries; $i++) {
            try {
              Write-Host "Download attempt $i/$maxRetries..."
              Invoke-WebRequest -Uri $url -OutFile "ollama.zip" -ErrorAction Stop
              Expand-Archive -Path "ollama.zip" -DestinationPath "ollama_temp" -Force
              
              # Find ollama.exe in extracted files (may be in subdirectory)
              $ollamaExe = Get-ChildItem -Path "ollama_temp" -Filter "ollama.exe" -Recurse | Select-Object -First 1
              if ($ollamaExe) {
                Copy-Item $ollamaExe.FullName -Destination "ollama.exe" -Force
                Remove-Item "ollama_temp" -Recurse -Force
                Remove-Item "ollama.zip" -Force
                Write-Host "✓ ollama.exe downloaded successfully"
                break
              } else {
                throw "ollama.exe not found in archive"
              }
            } catch {
              if ($i -eq $maxRetries) {
                throw "ERROR: Failed to download ollama.exe after $maxRetries attempts: $_"
              }
              Write-Host "Retrying in 5 seconds..."
              Start-Sleep -Seconds 5
            }
          }

      - name: Build portable EXE with PyInstaller
        shell: pwsh
        run: |
          # Build with console for debugging and portability
          pyinstaller --clean openwebui-portable.spec

          if (Test-Path "dist\OpenWebUI-Ollama-Portable\OpenWebUI-Ollama-Portable.exe") {
            Write-Host "✓ Build successful"
            # Verify ollama.exe exists in the packaged directory
            if (Test-Path "dist\OpenWebUI-Ollama-Portable\ollama.exe") {
              Write-Host "✓ ollama.exe found in package"
            } else {
              Write-Host "WARNING: ollama.exe not found in packaged directory - the build may be incomplete"
            }
          } else {
            throw "ERROR: Build failed - executable not found"
          }

      - name: Create portable ZIP package
        shell: pwsh
        run: |
          # Create a clean portable package
          $packageName = "OpenWebUI-Ollama-Portable-Windows"
          New-Item -ItemType Directory -Force -Path $packageName

          # Copy the built application
          Copy-Item -Recurse "dist\OpenWebUI-Ollama-Portable\*" "$packageName\"

          # Create README for users
          @"
          # Open WebUI + Ollama Portable Launcher

          ## Quick Start
          1. Extract this entire folder to a USB drive or any location
          2. Run OpenWebUI-Ollama-Portable.exe
          3. Wait for the browser to open automatically
          4. Access the interface at http://localhost:3000

          ## Features
          - Fully portable - runs from USB drive
          - No installation required
          - Leaves no traces on the host computer
          - All data stored in the application folder

          ## Data Locations
          - Models: .ollama/models/
          - User data: data/

          ## Troubleshooting
          - If ports 11434 or 3000 are in use, close other applications
          - Firewall may ask for permission - click Allow
          - First model download will take time

          ## Shutdown
          Press Ctrl+C in the console window or close the window
          "@ | Out-File -FilePath "$packageName\README.txt" -Encoding utf8

          # Create ZIP
          Compress-Archive -Path $packageName -DestinationPath "$packageName.zip" -Force
          Write-Host "✓ Portable package created: $packageName.zip"

      - name: Cleanup on failure
        if: failure()
        shell: pwsh
        run: |
          Write-Host "Cleaning up build artifacts..."
          Remove-Item -Path "ollama.exe" -ErrorAction SilentlyContinue
          Remove-Item -Path "ollama.zip" -ErrorAction SilentlyContinue
          Remove-Item -Path "ollama_temp" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "dist" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "build" -Recurse -Force -ErrorAction SilentlyContinue

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: openwebui-ollama-portable-windows
          path: OpenWebUI-Ollama-Portable-Windows.zip
          compression-level: 0 # Already compressed

      - name: Upload to release (if tagged)
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: OpenWebUI-Ollama-Portable-Windows.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
